<div class="auditoria-container">
  <div class="header-section">
    <h1>
      <mat-icon>history</mat-icon>
      Logs de Auditoria
    </h1>
    <p class="subtitle">
      Visualize todas as acoes realizadas no sistema
    </p>
  </div>

  <!-- Filtros Avancados -->
  <mat-expansion-panel class="filtros-panel">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon>filter_list</mat-icon>
        Filtros Avancados
      </mat-panel-title>
      <mat-panel-description>
        Refine sua busca nos logs de auditoria
      </mat-panel-description>
    </mat-expansion-panel-header>

    <form [formGroup]="filtrosForm" class="filtros-form">
      <div class="filtros-grid">
        <mat-form-field appearance="outline">
          <mat-label>Acao</mat-label>
          <mat-select formControlName="acao">
            <mat-option value="">Todas</mat-option>
            <mat-option *ngFor="let acao of acoes" [value]="acao">
              {{ acao }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>category</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Recurso</mat-label>
          <input matInput formControlName="recurso" placeholder="Ex: usuarios" />
          <mat-icon matPrefix>folder</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Data Inicio</mat-label>
          <input
            matInput
            [matDatepicker]="pickerInicio"
            formControlName="dataInicio"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="pickerInicio"
          ></mat-datepicker-toggle>
          <mat-datepicker #pickerInicio></mat-datepicker>
          <mat-icon matPrefix>calendar_today</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Data Fim</mat-label>
          <input
            matInput
            [matDatepicker]="pickerFim"
            formControlName="dataFim"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="pickerFim"
          ></mat-datepicker-toggle>
          <mat-datepicker #pickerFim></mat-datepicker>
          <mat-icon matPrefix>calendar_today</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Endereco IP</mat-label>
          <input matInput formControlName="ip" placeholder="192.168.0.1" />
          <mat-icon matPrefix>router</mat-icon>
        </mat-form-field>
      </div>

      <div class="filtros-actions">
        <button mat-button (click)="limparFiltros()" type="button">
          <mat-icon>clear</mat-icon>
          Limpar Filtros
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="aplicarFiltros()"
          type="button"
        >
          <mat-icon>search</mat-icon>
          Aplicar Filtros
        </button>
      </div>
    </form>
  </mat-expansion-panel>

  <!-- Acoes -->
  <div class="actions-bar">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Busca rapida</mat-label>
      <input
        matInput
        (keyup)="applyFilter($event)"
        placeholder="Usuario, recurso, IP..."
        #input
      />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <button
      mat-raised-button
      color="accent"
      (click)="exportarLogs()"
      class="export-button"
    >
      <mat-icon>download</mat-icon>
      Exportar CSV
    </button>
  </div>

  <div class="info-box">
    <mat-icon>info</mat-icon>
    <p>
      Logs de auditoria registram todas as acoes importantes realizadas no
      sistema. Os registros sao mantidos permanentemente para fins de seguranca
      e conformidade.
    </p>
  </div>

  <!-- Spinner de carregamento -->
  <div *ngIf="loading" class="loading-spinner">
    <mat-spinner></mat-spinner>
    <p>Carregando logs...</p>
  </div>

  <!-- Tabela de Logs -->
  <div class="table-container mat-elevation-z4" *ngIf="!loading">
    <table mat-table [dataSource]="dataSource" matSort class="logs-table">
      <!-- Timestamp Column -->
      <ng-container matColumnDef="timestamp">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Data/Hora</th>
        <td mat-cell *matCellDef="let log">
          <div class="timestamp-cell">
            <mat-icon>access_time</mat-icon>
            {{ formatDate(log.timestamp) }}
          </div>
        </td>
      </ng-container>

      <!-- Usuario Column -->
      <ng-container matColumnDef="usuario">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Usuario</th>
        <td mat-cell *matCellDef="let log">
          <div class="usuario-cell" *ngIf="log.usuario || log.username">
            <mat-icon>person</mat-icon>
            <div>
              <strong>{{ log.usuario?.nome || log.username || 'Sistema' }}</strong>
              <small *ngIf="log.usuario">{{ log.usuario.username }}</small>
            </div>
          </div>
          <span *ngIf="!log.usuario && !log.username">Sistema</span>
        </td>
      </ng-container>

      <!-- Acao Column -->
      <ng-container matColumnDef="acao">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Acao</th>
        <td mat-cell *matCellDef="let log">
          <mat-chip [class]="getAcaoClass(log.acao)">
            <mat-icon>{{ getAcaoIcon(log.acao) }}</mat-icon>
            {{ log.acao }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Recurso Column -->
      <ng-container matColumnDef="recurso">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Recurso</th>
        <td mat-cell *matCellDef="let log">
          <div class="recurso-cell">
            <mat-icon>folder_open</mat-icon>
            <span>{{ log.recurso || '-' }}</span>
          </div>
        </td>
      </ng-container>

      <!-- IP Column -->
      <ng-container matColumnDef="ip">
        <th mat-header-cell *matHeaderCellDef>IP</th>
        <td mat-cell *matCellDef="let log">
          <span class="ip-address">{{ log.detalhes?.ipOrigem || 'N/A' }}</span>
        </td>
      </ng-container>

      <!-- Detalhes Column -->
      <ng-container matColumnDef="detalhes">
        <th mat-header-cell *matHeaderCellDef>Detalhes</th>
        <td mat-cell *matCellDef="let log">
          <span
            class="detalhes-text"
            [matTooltip]="log.detalhes?.motivo || 'Sem detalhes'"
          >
            {{ truncateText(log.detalhes?.motivo, 30) || '-' }}
          </span>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- Row shown when there is no matching data -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="6">
          <div class="no-data">
            <mat-icon>inbox</mat-icon>
            <p>Nenhum log de auditoria encontrado</p>
          </div>
        </td>
      </tr>
    </table>

    <mat-paginator
      [pageSizeOptions]="[10, 25, 50, 100]"
      showFirstLastButtons
      aria-label="Selecionar pagina de logs"
    ></mat-paginator>
  </div>
</div>

<!--
   __  ____ ____ _  _
 / _\/ ___) ___) )( \
/    \___ \___ ) \/ (
\_/\_(____(____|____/
-->
