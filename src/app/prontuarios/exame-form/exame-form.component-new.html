<div class="exame-form-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>science</mat-icon>
        Registrar Novo Exame
      </mat-card-title>
      <mat-card-subtitle>
        Preencha os dados basicos e anexe resultados (PDFs, imagens, laudos)
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Formulario Basico -->
      <form
        [formGroup]="exameForm"
        (ngSubmit)="onSubmit()"
        class="exame-form"
        *ngIf="!exameSalvo"
      >
        <!-- ID do Profissional -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>ID do Profissional Responsavel</mat-label>
          <input
            matInput
            type="number"
            formControlName="profissionalSolicitanteId"
            placeholder="Digite o ID do profissional"
          />
          <mat-icon matSuffix>badge</mat-icon>
          <mat-error
            *ngIf="exameForm.get('profissionalSolicitanteId')?.hasError('required')"
          >
            {{ getErrorMessage("profissionalSolicitanteId") }}
          </mat-error>
        </mat-form-field>

        <!-- Tipo de Exame -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Tipo de Exame</mat-label>
          <mat-select formControlName="tipoExame">
            <mat-option *ngFor="let tipo of tiposExame" [value]="tipo">
              {{ tipo }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>category</mat-icon>
          <mat-error *ngIf="exameForm.get('tipoExame')?.hasError('required')">
            {{ getErrorMessage("tipoExame") }}
          </mat-error>
        </mat-form-field>

        <!-- Nome do Exame -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nome do Exame</mat-label>
          <input
            matInput
            formControlName="nomeExame"
            placeholder="Ex: Hemograma Completo, Raio-X Torax"
          />
          <mat-icon matSuffix>assignment</mat-icon>
          <mat-error *ngIf="exameForm.get('nomeExame')?.hasError('required')">
            {{ getErrorMessage("nomeExame") }}
          </mat-error>
        </mat-form-field>

        <!-- Descricao -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Descricao</mat-label>
          <textarea
            matInput
            formControlName="descricao"
            rows="3"
            placeholder="Breve descricao ou motivo do exame"
          ></textarea>
          <mat-icon matSuffix>description</mat-icon>
        </mat-form-field>

        <!-- Data do Exame -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Data do Exame</mat-label>
          <input
            matInput
            [matDatepicker]="picker"
            formControlName="dataSolicitacao"
            placeholder="Selecione a data"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="picker"
          ></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error
            *ngIf="exameForm.get('dataSolicitacao')?.hasError('required')"
          >
            {{ getErrorMessage("dataSolicitacao") }}
          </mat-error>
        </mat-form-field>

        <!-- Observacoes -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Observacoes (Opcional)</mat-label>
          <textarea
            matInput
            formControlName="observacoes"
            rows="4"
            placeholder="Observacoes sobre o exame, resultados, recomendacoes, etc."
          ></textarea>
          <mat-icon matSuffix>note</mat-icon>
          <mat-hint>Campo livre para anotacoes</mat-hint>
        </mat-form-field>

        <!-- Botoes de Acao -->
        <div class="form-actions">
          <button
            mat-button
            type="button"
            (click)="goBack()"
            [disabled]="loading"
          >
            <mat-icon>arrow_back</mat-icon>
            Cancelar
          </button>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="loading"
          >
            <mat-icon>save</mat-icon>
            {{ loading ? "Salvando..." : "Salvar e Continuar" }}
          </button>
        </div>
      </form>

      <!-- Secao de Anexos (apos salvar exame) -->
      <div *ngIf="exameSalvo && exameId" class="anexos-section">
        <div class="success-message">
          <mat-icon color="primary">check_circle</mat-icon>
          <p>
            Exame registrado com sucesso! Agora voce pode anexar resultados.
          </p>
        </div>

        <app-anexos-upload
          tipo="exame"
          [registroId]="exameId"
          (uploadCompleto)="onUploadCompleto($event)"
          (uploadErro)="onUploadErro($event)"
        >
        </app-anexos-upload>

        <div class="form-actions">
          <button mat-raised-button color="primary" (click)="finalizar()">
            <mat-icon>check</mat-icon>
            Finalizar
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!--
   __  ____ ____ _  _
 / _\/ ___) ___) )( \
/    \___ \___ ) \/ (
\_/\_(____(____|____/
-->
